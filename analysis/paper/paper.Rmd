---
title: "Bayesian exponential random graph modelling of KWL Burial network"
author:
  - Author One
  - Author Two
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    bookdown::html_document2:
      fig_caption: yes
      reference_docx: "../templates/template.docx" # Insert path for the DOCX file
bibliography: references.bib
csl: "../templates/journal-of-archaeological-science.csl" # Insert path for the bib-style
abstract: |
  Text of abstract
keywords: |
  keyword 1; keyword 2; keyword 3
highlights: |
  These are the highlights. 
---


<!-- This is the format for text comments that will be ignored during renderings. Do not put R code in these comments because it will not be ignored. -->

```{r setup, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  fig.path = "../figures/"
)
```

# Introduction

Burials provide valuable information about social structures that reflect not only the personal life and status of the deceased, but also the expressions of their descendants, from which we are able to detect the social differences that can relate to social inequality and complexity [@Ehrhardt2009; @Gamble2002; @Janes2013; @Johansen2015]. Mortuary practices such as burial forms, grave goods, and related ritual practices could represent the social relations between individuals and allow us to infer social structures, for examples, grave goods usually relate to social practices of trade, exchange, and gifting [@Coward2013, pp. 252]. One way to study the relationships between individual is social network analysis (SNA), which can visualize, quantify, and statistically test hypotheses about the relationships to understand network structure and its effects on every part within the network [@Freeman2004; @Salvini2010]. A social network contains a set of actors and a set of relationships connecting these actors, which could be groups, organizations or persons. Their relationships are flows of resources that reflect relations of control, dependence, and cooperation. In other words, actors are viewed as "nodes" in a wider network, in which nodes are connected by multiple relationships, or "edges", to other nodes [@Coward2013; @Mizoguchi2013; @Potgieter2008]. 

Exponential Random Graph Models (ERGMs) are an important family of statistical model for network analysis to describe the formation of ties in a network. In traditional statistical model for network, a dyad, the pair of nodes, is measured by the presence of a tie according to the attributes of the nodes or ties, where each predictor variable for forming a tie is measured separately. In contrast to traditional model where variables not interacting with each other, ERGMs assumes the formation of a tie is influenced by the presence or absence of other ties or attributes of nodes and ties (Robins et al. 2007). In a network using ERGMs, predictor variables, called "network statistics", are direct functions of the ties themselves that the probability of occurrence of the configuration of ties can be hypothesized [@Morris2008]. This approach enables networks to be constructed in a variety of assumption and contexts to model social network in the past using archaeological data [@Amati2019]. However, ERGMs are difficult to compute because their normalizing constant, which depends on model parameters, is intractable. A Bayesian framework allows for parameter inference using MCMC strategies which avoid the need for computationally intensive calculations of the normalizing constants. 

Using the R language, we use Bayesian SNA to study burials from Kiwulan, an Iron Age site in northeast Taiwan. We view individual burials as actors or nodes in the social network with ties drawn between burials when the presence of the same variables that can represent the same "community" or social group. We test hypotheses about the distribution of influence in the network to identify network or corporate mode conditions. We ask the questions: 1. Do the observed burial data indicate a more clustered network than a distribution of random networks with similar qualities? 2. Whether European colonial activities in 17 century Taiwan resulted in the emergence of social inequality in an indigenous society can be detected by burials networks. We expect the network to present a higher degree of clustering (e.g. the number of completed triangles in the network) in the European contact period that might hint at social heterogeneity during this period. This study helps to expand the use of burials in understanding the indirect effects of a colonial presence on indigenous groups. A Bayesian approach enables the efficient quantification for uncertainty, parametrization, and model evaluation of social network metrics.

# Archaeological background

The burial data we analyzed in this paper are collected from the upper component of Kiwulan site, an Iron Age settlement site (AD1350-AD1950) located in northeastern Taiwan which experienced the European colonial impacts in the 17th century and the large wave of Chinese immigrants in the 19th century. The burials were assigned to pre-European contact period, post-European contact period, and Chinese period based on the stratigraphic data, radiocarbon dates, and diagnostic porcelain such as white-glazed jars as a time indicator of the arrival of the Europeans[citation]. The excavation revealed abundent pottery sherds, imported ceramics and stonewares, wooden artifacts, stone tools, metal artifacts, imported glass beads and agates beads, and pipes [\@Chen2007]. In addition to these artifacts, 90 burials, hundreds of middens, storage pits, and postholes with in-situ posts were also excavated. The burials were mostly located in the AD section, which is the largest open area at Kiwulan site that provides continuous stratigraphic sections suitable for comparison. Those burials are oriented in an east-west direction located on the north side of the house structures indicated by postholes and in-situ wooden posts. Previous research indicates the presence of economic inequality between burials, but there is debate about whether these represent an egalitarian or stratified society [\@Cheng 2008; \@Hsieh 2009a]. Cheng (2008) interprets the unequal distribution of prestige materials, such as the golden beads, between burials, as evidence for hierarchy. However, Hsieh (2012) suggests a relatively egalitarian form from the comparative analysis of frequency and proportion of burial goods. She finds that the rich burials were usually associated with elders, which might indicate achieved, rather than inherited, status. The use of prestige goods in burials might be traced back before the European arrival according to historical records from Spanish and Chinese (Borao Mateo 2009; Li and Wu 2006). If Cheng is correct and socio-economic inequality was present, it might be rooted in the use of prestige goods traded in the area before the Europeans arrived. In this case, pre-existing inequalities might have become more accentuated as a response to European contact. Did the degree of economic inequality change over time, and how did European contact impact indigenous social organization? These questions motivate this project.


The archaeological sites in northeastern Taiwan show some evidence of accumulation of imported prestige goods in burials (Chen 2005; Cheng 2008), which might indicate the pursuit of prestige or wealth. In addition to prestige, European colonial powers could have provided military support to indigenous allies. For example, Vossâ€™s (2005) study of a colonial outpost in California shows that colonial residents have different identities and higher social status than other local indigenous people. A general model to summarize these case studies might be that the support of a colonial power combined with high local values for imported goods, might lead to competition among individuals. In this study, I will use this model of competition to explain the changes in social inequality at Kiwulan before and after European contact.


Based on the quantity and quality of grave goods among burials, we can reconstruct social networks from the distribution of prestige goods, including imported ceramic and beads based on the principle that prestige materials usually relate to social status. We build network where burials represent actors (nodes in the network) linked by sharing the same prestige goods. 


# Methods

## Exponential Random Graph Models

some concepts:
- endogenous statistics that ties are modelled based on the existence of other ties
- exogenous statistics that ties are formed according to monadic or dyadic node attributes


## statistics
We want to know 

ERGM- consider transitivity by taking into account high-order k-triangles. Triangles and higher order cycles

We used ergm package in R for the model specification. Every term in an ERGM must have an associated algorithm for computing its value for network [@Morris2008]. The terms we selected for nwtwork specification include:

1. edges: ties, a measure of density, equal to kstar(1) for undirected networks

2. gwesp (geometrically weighted edgewise shared partners): triad-based clustering based on a dyad-based configurations (not node-based) that counts the number of times that both nodes have a tie to a third node. It is a measure of the tendency for two actors who are tied to have x partners in common. In orther words, a tendency for those with shared partners to become tied, or tendency of ties to cluster together.

3. gwdegree (geometrically weighted degree distribution): a parametric form that represents the frequency distribution for nodal degree, each node counts only once. The local configuration is degrees and stars that are equivalent representations for the distribution of node-based edge counts. A measure of the tendency of the number of edges into a node. gwdegree estimates the change in tie likelihood given the degree of the nodes involved, but with marginally decreasing weighting as degree increases(https://www.r-bloggers.com/ergm-tutorial/). This statistic captures the tendency towards centralisation in the degree distribution of the network.

# Results

```{r model-ergm-1}
model.ergm <- burial_network_pre ~ 
  edges + # ties, a measure of density, equal to kstar(1) for undirected networks
  density +
  gwdegree(0.5, fixed = TRUE) +
  triangle # triad relation, a measure of clustering or cohesion, also called transitive triple in undirected network, can be replaced by "gwdegree"
summary(model.ergm)
```

```{r model-ergm-2}
# check out the terms: http://mailman13.u.washington.edu/pipermail/statnet_help/2010/000575.html
# also check here Morris et al. (2008)
model.2 <- burial_network_pre ~ edges + # density
  gwesp(0.2, fixed = TRUE) +  # transitivity(cohesion; triangle)
  # number means weight parameter alpha, which controls the rate of declining marginal returns
  # fixed = TRUE means the scale parameter lambda is fit as a curved exponential-family model
  # not much difference in a range of 0-1.5, the lower the value of the scaling parameter, the less likely the model is to be degenerate
  # ergm can estimate the parameter from the data by using fixed=FALSE

  gwdegree(0.8, fixed = TRUE)  # popularity(degree; star), the frequency distribution for nodal degrees
  # tendency of being in contact with multiple partners, measures of centralisation
  # distribution of node-based edge counts, each node counts only once
  # number means weight parameter decay
  # The closer decay is to zero, the more gwdegree considers low degree nodes relative to high degree nodes
summary(model.2)
```


```{r model-ergm-3}
model.3 <- burial_network_pre ~ edges +  # the overall density of the network
  nodematch('quantity') + # quantity-based homophily, categorical nodal attribute
  # the similarity of connected nodes
  gwesp(0.2, fixed = TRUE) +  # transitivity
  gwdegree(0.8, fixed = TRUE) # popularity
summary(model.3)
```

Normal distribution ðœƒ âˆ¼ Nd (ðœ‡prior , Î£prior ) is viewed as a suitable prior model for the model parameters of interests in network analysis [@Caimo2017]. We specified the prior based on normal distribution that assumes a low density and high transitivity network. 

```{r model-bergm}
# Specify a prior distribution: normal distribution (low density and high transitivity)
prior.mean <- c(-3, 0, 1, 0) # prior mean corresponds to mean for each parameter
# follow Alberto Caimo et al. (2015) hospital example
prior.sigma <- diag(3, 4, 4) # covariance matrix structure
# where the dimension d corresponds to the number of parameters, ðœ‡ is mean vector and Î£prior is a d Ã— d covariance matrix.

# Estimated posterior means, medians and 95% credible intervals for Models.3
# bergmM: Bayesian exponential random graphs models under missing data using the approximate exchange algorithm
parpost <- bergm(model.3,
                  prior.mean  = prior.mean,
                  prior.sigma = prior.sigma,
                  burn.in     = 200, # burn-in iterations for every chain of the populationm, drops the first 200
                  main.iters  = 2000, # iterations for every chain of the population
                  aux.iters   = 10000, # MCMC steps used for network simulation
                  nchains     = 8, # number of chains of the population MCMC
                  gamma       = 0.7) # scalar; parallel adaptive direction sampling move factor, acceptance rate

summary(parpost) 
```

The summary presents the statistics that each Î¸ corresponds to the parameter specified in ERGM previously. In general, positive mean indicates positive correlation, while negative mean indicates negative correlation. 

Î¸1 = number of ties
Î¸2 = individuals with the same abundance of burial goods
Î¸3 = gwesp, a positive sign suggests a tendency of burials in our sample to group together in closed transitive structures. In mortuary context, clustering implies a tendency of burials with the same status indicated by prestige goods to be organised in closed structures. Burials with multiple prestige goods in common are more likely to be directed connected.
Î¸4 = gwdegree, negative estimates reflect an increased likelihood on ties to higher-degree nodes, or the strong edges are not necessarily centralised or dispersed in the degree distribution.

inline code `r x` example

# Discussion

# Conclusion

# Acknowledgements

<!-- The following line inserts a page break when the output is MS Word. For page breaks in PDF, use \newpage on its own line.  -->
##### pagebreak

# References 
<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->
<div id="refs"></div>

##### pagebreak

### Colophon

This report was generated on `r Sys.time()` using the following computational environment and dependencies: 

```{r colophon, cache = FALSE}
# which R packages and versions?
if ("devtools" %in% installed.packages()) devtools::session_info()
```

The current Git commit details are:

```{r}
# what commit is this file at? 
if ("git2r" %in% installed.packages() & git2r::in_repository(path = ".")) git2r::repository(here::here())  
```
