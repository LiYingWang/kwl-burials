---
title: "Bayesian exponential random graph modeling of KWL Burial network"
author:
  - Author One
  - Author Two
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    bookdown::word_document2:
      fig_caption: yes
      reference_docx: "../templates/template.docx" # Insert path for the DOCX file
bibliography: references.bib
csl: "../templates/journal-of-archaeological-science.csl" # Insert path for the bib-style
abstract: |
  Text of abstract
keywords: |
  keyword 1; keyword 2; keyword 3
highlights: |
  These are the highlights. 
---


<!-- This is the format for text comments that will be ignored during renderings. Do not put R code in these comments because it will not be ignored. -->

```{r setup, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  fig.path = "../figures/"
)
```

# Introduction

<!--burial study- network analysis-->
Burials provide valuable information about social structures that reflect not only the personal life and status of the deceased, but also the expressions of their descendants, from which we are able to detect the social differences that can relate to social inequality and complexity [@Ehrhardt2009; @Gamble2002; @Janes2013; @Johansen2015]. Mortuary practices such as burial forms, grave goods, and related ritual practices could represent the social relations between individuals and allow us to infer social structures, for examples, grave goods usually relate to social practices of trade, exchange, and gifting [@Coward2013, pp. 252]. One way to study the relationships between individual is social network analysis (SNA), which can visualize, quantify, and statistically test hypotheses about the relationships to understand network structure and its effects on every part within the network [@Freeman2004; @Salvini2010]. A social network contains a set of actors and a set of relationships connecting these actors, which could be groups, organizations or persons. Their relationships are flows of resources that reflect relations of control, dependence, and cooperation. In other words, actors are viewed as "nodes" in a wider network, in which nodes are connected by multiple relationships, or "edges", to other nodes [@Coward2013; @Mizoguchi2013; @Potgieter2008]. 

<!--archaeology case-->
The archaeological sites in northeastern Taiwan show some evidence of accumulation of imported prestige goods in burials around the same time as European contact in the 17th century[@Chen2007], which might indicate the pursuit of prestige or wealth in the society. In addition to prestige, European colonial powers could have provided military support to indigenous allies. For example, @Voss2005's study of a colonial outpost in California shows that colonial residents have different identities and higher social status than other local indigenous people. A general model to summarize these case studies might be that the support of a colonial power combined with high local values for imported goods, might lead to competition among individuals. In this study, we will use this model of competition to explain the changes in social inequality at Kiwulan, an Iron Age site in northesatern Taiwan, which covers the presence of the Europeans, inculding the Spanish and the Dutch, in the 17th century and the Chinese in the 19th century. 

<!--current approaches to network analysis-->
Exponential Random Graph Models (ERGMs) are an important family of statistical model for expressing properties of network structures with a focus directly on possible ties between nodes by viewing them as random variables [@Robins2007]. In traditional statistical model for network, each predictor variable for forming a tie between two nodes is measure separately by the presence of a tie without considering interactions among ties [@Morris2008]. By contrast, statistical models assumes social networks as dependent variables that can represent the network dependencies between tie variables [@Snijders2011]. In a network generated by ERGMs, the formation of a tie is influenced by the presence or absence of other ties or attributes of nodes/ties. Predictor variables, called network statistics, such as reciprocity, transitivity, homophily, are direct functions of the ties themselves where the probability of occurrence of the configuration of ties can be specified and hypothesized [@Morris2008; @Robins2007]. The advantage of networks specification under assumptions and contexts can be useful to explain archaeological network in a given time. For example, @Amati2019 demonstrate the use of ERGMs to reconstruct networks consist of a set of sites in the Caribbean during the period AD 100‚Äì400. They found the structure of network can be efficiently explained by multiple interdependent mechanisms instead of hypotheses of distance and cultural homophily exclusively. However, they also point out some limitations of application such as static outcome and sensitivity to missing data. Another limitation is that ERGMs are difficult to compute because their normalizing constant depending on model parameters is intractable. With the development of Markov chain Monte Carlo (MCMC) algorithms that produce approximate maximum likelihood estimators and graph statistics for further specification of transitivity and heterogeneity, ERGMs can deal with complicated dependence patterns observed at one moment in time [@Snijders2006]. A Bayesian framework allows for parameter inference using Markov chain Monte Carlo (MCMC) strategies which avoid the need for computationally intensive calculations of the normalizing constants [@Caimo2011]. 

## Bayesian modeling 

<!--Bayesian inference for Exponential Random Graph Models--> 
Bayesian approach to ERGMs is an efficient computational tool for social network analysis because it incorporates prior information about the network effects into the model and offers uncertainty quantification by evaluating the posterior distribution of the parameters associated with the network effects [@Caimo2015; @Nemmers2019]. This provides better estimations for complex social network models with heterogeneous data [@Caimo2017]. For archaeological data, missing data could be a problem leading to misinterpretation, which can be also reduced by using Bayesian modelling that provides average 80% correct prediction for the ties and allow 25% false with a third of data missing [@Koskinen2010].
- weighted data

Using the R language, we use Bayesian SNA to study burials from Kiwulan, an Iron Age site in northeast Taiwan. We view individual burials as actors or nodes in the social network with ties drawn between burials when the presence of the same variables that can represent the same "community" or social group. We test hypotheses about the distribution of influence in the network to identify network or corporate mode conditions. We ask the questions: 1. Do the observed burial data indicate a more clustered network than a distribution of random networks with similar qualities? 2. Whether European colonial activities in 17 century Taiwan resulted in the emergence of social inequality in an indigenous society can be detected by burials networks. 3. How the relations among burials may affect the quantity of burial goods? We expect the network to present a higher degree of clustering (e.g. the number of completed triangles in the network) in the European contact period that might hint at social heterogeneity during this period. This study helps to expand the use of burials in understanding the indirect effects of a colonial presence on indigenous groups. A Bayesian approach enables the efficient quantification for uncertainty, parametrization, and model evaluation of social network metrics.

# Archaeological background

```{r read-data}
library(readxl)
library(tidyverse)
library(here)

# read data
burial <- read_excel(here("analysis", "data", "raw_data", "Kiwulan_Burials.xlsx"))
```

```{r tidy-data}
# combine some periods
burial_three_period_tidy <-
  burial %>%
  rename(burial_label = ID) %>%
  mutate(Phase = ifelse(Phase == 'euro', 'post', Phase)) %>%
  filter(!is.na(Phase)) %>%
  mutate(Gold_leaf = ifelse(Gold_leaf == "shatter", "1", Gold_leaf),
         Stoneware = ifelse(Stoneware == "base", "1", Stoneware),
         Stamped_ceramic = ifelse(Stamped_ceramic == "cluster", "1", Stamped_ceramic)) %>%
  mutate_at(21:ncol(.), as.numeric) %>%
  janitor::remove_empty(which = "cols") %>%
  mutate(total = rowSums(.[c(21:48, 50, 55, 56)], na.rm = TRUE)) %>% #prestige goods
  mutate(Porcelain = rowSums(.[c(40:48, 55, 56)], na.rm = TRUE)) %>% #B&W, porcelain, Anping, kendi
  mutate(Porcelain = ifelse(Porcelain == 0, NA, Porcelain)) %>%
  mutate(quantity = case_when(
    total == 0 ~ "none",
    total > 0 & total <= 7 ~ "low",
    total > 7 & total < 100 ~ "medium",
    total >= 100 ~ "high",
    TRUE ~ "other")) %>% # the classification is based on the result of histogram
  mutate(Age_scale = case_when(
    `Age` %in% c("1","2") ~ "0-12",
    `Age` == "3" ~ "12~20",
    `Age` %in% c("4","5","6","7","8") ~ "+20",
    TRUE ~ "NA")) %>%
    mutate(gender = case_when(
    `Gender` %in% c("1","2") ~ "male",
    `Gender` %in% c("3","4") ~ "female",
    TRUE ~ "NA")) %>%
  mutate(Gold_bead_low = ifelse(Golden_bead == 1, 1, NA),
         Gold_bead_med = ifelse(Golden_bead > 1 & Golden_bead <10, 1, NA),
         Gold_bead_high = ifelse(Golden_bead > 10, 1, NA),
         Agate_bead_low = ifelse(Agate_bead == 1, 1, NA),
         Agate_bead_med = ifelse(Agate_bead > 1 & Agate_bead <10, 1, NA),
         Agate_bead_high = ifelse(Agate_bead > 10, 1, NA),
         `Indo-Pacific_bead_low` = ifelse(`Indo-Pacific_bead` < 100, 1, NA),
         `Indo-Pacific_bead_med` = ifelse(`Indo-Pacific_bead` > 100 & `Indo-Pacific_bead` < 900, 1, NA),
         `Indo-Pacific_bead_high` = ifelse(`Indo-Pacific_bead` > 900, 1, NA)) %>% 
  # the low-med-high index is determined by interpretation for histograms for those burial good types
  select(burial_label,
         Phase,
         Age_scale,
         gender,
         Gold_bead_low,
         Gold_bead_med,
         Gold_bead_high,
         Agate_bead_low,
         Agate_bead_med,
         Agate_bead_high,
         #Agate_bead, #female burials
         #Golden_bead,
         Porcelain,
         Gold_leaf, #prestige good
         fish_shape_knit, #prestige good
         #Bell, #children's burials
         quantity)
         #total) # select specific variable to drop columns (uninformative variables)

# number of each phase
burial_three_period_number <-
  burial_three_period_tidy %>%
  count(Phase)
```

```{r prep-network-object-pre}
# filter pre burials
burial_pre <-
  burial_three_period_tidy %>%
  filter(Phase == "pre") %>%
  janitor::remove_empty(which = "cols")

# create node list using burial index by phase
#--------------------pre--------------------------------
nodes_pre <-
  burial_three_period_tidy %>%
  filter(Phase == "pre") %>%
  select(burial_label) %>%
  rowid_to_column("id")

# pair wise combinations for burials as index for later map function
library(gtools)
burial_comb_pre = combinations(length(nodes_pre$burial_label), #t(combn(nodes_pre$burial_label, 2))
                               2, nodes_pre$burial_label,
                               repeats = TRUE)
colnames(burial_comb_pre) = c("burial_1", "burial_2")
burial_comb_pre = as_tibble(burial_comb_pre)

# create list for each burial that contains the burial good types and their counts
edge_list_pre <-
  burial_three_period_tidy %>%
  select(burial_label, 5:13) %>% # need to change for each exploration
  pivot_longer(-burial_label, names_to = "goods", values_to = "count") %>%
  #mutate(burial_connection = rep(unique(burial_label), length.out = length(burial_label)))
  group_by(burial_label) %>%
  nest()

# pair-wise list
common_counts_lst_pre <-
map2(burial_comb_pre$burial_1,
     burial_comb_pre$burial_2,
     ~bind_cols(
       edge_list_pre %>%
       filter(burial_label == .x) %>%
       unnest(data),
       edge_list_pre %>%
         filter(burial_label == .y) %>%
         unnest(data)) %>%
       rowwise() %>%
       mutate(common_counts = sum(count, count1)))

# count of ornament types in common between each pair of burials
common_counts_vct_pre <- map_int(common_counts_lst_pre, ~sum(!is.na(.x$common_counts)))

burial_comb_with_common_counts_pre <-
burial_comb_pre %>%
  mutate(common_counts = common_counts_vct_pre) %>%
  mutate(common_counts = ifelse(burial_1 == burial_2, 0, common_counts)) # use 0 for self loop

# change label to ids for node linking
edges_pre <-
  burial_comb_with_common_counts_pre %>%
  left_join(nodes_pre, by = c("burial_1" = "burial_label")) %>%
  rename(from = id) %>%
  left_join(nodes_pre, by = c("burial_2" = "burial_label")) %>%
  rename(to = id)

edges_for_network_pre <-
  select(edges_pre, from, to, common_counts) %>%
  filter (!common_counts == 0) # remove rows with no goods in common
 # %>% mutate(common_counts = ifelse(common_counts > 1, 1, common_counts)) # for unweighted network
```

```{r prep-network-object-post}
# filter post burials
burial_post <-
  burial_three_period_tidy %>%
  filter(Phase == "post") %>%
  janitor::remove_empty(which = "cols")

# create node list
nodes_post <-
  burial_three_period_tidy %>%
  filter(Phase == "post") %>%
  select(burial_label) %>%
  rowid_to_column("id")

# pair wise combinations for burials as index for later map function
library(gtools)
burial_comb_post = combinations(length(nodes_post$burial_label),
                               2, nodes_post$burial_label,
                               repeats = TRUE)
colnames(burial_comb_post) = c("burial_1", "burial_2")
burial_comb_post = as_tibble(burial_comb_post)

# create list for each burial that contains the burial good types and their counts
edge_list_post <-
  burial_three_period_tidy %>%
  select(burial_label, 5:13) %>% # need to change for each exploration
  pivot_longer(-burial_label, names_to = "goods", values_to = "count") %>%
  group_by(burial_label) %>%
  nest()

# pair-wise list
common_counts_lst_post <-
  map2(burial_comb_post$burial_1,
       burial_comb_post$burial_2,
       ~bind_cols(
         edge_list_post %>%
           filter(burial_label == .x) %>%
           unnest(data),
         edge_list_post %>%
           filter(burial_label == .y) %>%
           unnest(data)) %>%
         rowwise() %>%
         mutate(common_counts = sum(count, count1)))

# count of ornament types in common between each pair of burials
common_counts_vct_post <- map_int(common_counts_lst_post, ~sum(!is.na(.x$common_counts)))

burial_comb_with_common_counts_post <-
  burial_comb_post %>%
  mutate(common_counts = common_counts_vct_post) %>%
  mutate(common_counts = ifelse(burial_1 == burial_2, 0, common_counts)) # use 0 for self loop

# change label to ids for node linking
edges_post <-
  burial_comb_with_common_counts_post %>%
  left_join(nodes_post, by = c("burial_1" = "burial_label")) %>%
  rename(from = id) %>%
  left_join(nodes_post, by = c("burial_2" = "burial_label")) %>%
  rename(to = id)

edges_for_network_post <-
  select(edges_post, from, to, common_counts) %>%
  filter (!common_counts == 0) # remove rows with no goods in common
```

<!--archaeological setting-->
We analyzed burial data collected from the upper component of Kiwulan site, an Iron Age settlement site (AD1350-AD1950) located in northeastern Taiwan, which experienced the European colonial impacts in the early 17th century and the large wave of Chinese immigrants in the 19th century [@Chen2007]. The excavation revealed abundant pottery sherds, imported ceramics and stonewares, wooden artifacts, stone tools, metal artifacts, imported glass beads and agates beads, and pipes [@Chen2007]. In addition to these artifacts, 90 burials, hundreds of middens, storage pits, and postholes with in-situ posts were also excavated. The burials are mostly located in the AD section, which is the largest open area at Kiwulan that provides continuous stratigraphic sections suitable for temporal comparison. Those burials are oriented in an east-west direction on the north side of the house structures indicated by postholes and `in-situ` wooden posts, indicating a well organized space arrangement. 

Previous studies on burials suggest a presence of uneven distribution of prestige goods across burials. However, there is a debate over whether the differentiation between burials hints an economic inequality supporting an egalitarian society [@Hsieh2012], or political inequality indicating a stratified society [@Cheng2008]. @Cheng2008 interprets the unequal distribution of prestige materials, especially the gold-foil beads between burials, as evidence for hierarchy. However, @Hsieh2012 suggests a relatively egalitarian society based on the comparative analysis of frequency and proportion of all burial goods. She found that the burials with rich goods were usually associated with elders, which might indicate achieved, rather than inherited, status. The earliest record of the use of prestige goods in burials can be traced back around the European arrival according to historical records from the Spanish and the Chinese [@Borao2009; @LiandWu2006]. For example, the Spanish document by a Spanish Priest described that the Spanish soldier used agate beads to exchange materials from local indigenous people since they were valuable in their culture [@LiandWu2006]. In addition, there was a custom that people would bury imported materials with deceased to display their status and influence [@LiandWu2006]. Despite we observed the economic differentiation in burial goods and the high value of imported goods according to historical documents, the degree of inequality over time, and which variable decides the changes remain unclear. Analyzing and comparing burial data from different phases using network analysis approaches will give an insight into the degree and changes in social inequality. This is important to understand the social reactions of Kiwulan residents in the context of the foreign contact. 

<!--chronology-->
We assigned burials to the pre-European period, European and post-European period for network comparison according to depth, radiocarbon dates, diagnostic materials, stratigraphic data, and previous studies. Since the sedimentary characteristics show vertical and lateral continuity cross units of AD section, depth is used as the first criterion for burial chronology. The chronology is then evaluated by the burials with time marker, light gray glazed jars, also called An-ping jars. The jars were believed to be produced in Southeast China and circulated in Southeast Asia from the late 16th to 18th century, but are often found at sites with the European occupation in the early 17th century in Taiwan [@Berrocal2018; @Hsieh1995; @Ketel2011]. In addition to the diagnostic jars, three radiocarbon dates of charcoal associated with three different burials are used as another evidence to evaluate the chronology [@Chen2007]. Some burials that were heavily disturbed by modern construction are excluded to avoid misinterpreting due to incomplete data. With the information of burials, including quantity of grave goods, types of grave goods, burial identities, we can reconstruct social relations between individuals by linking them according to similar variables. This is based on the principle that prestige materials usually relate to a representation of social status, where the same economic or social class, tend to use similar goods as a status indicators [citations]. Therefore, we build network where burials represent actors (nodes in the network) that are linked when they have th same prestige goods in common. The prestige goods we identified including agate beads, gold-foil beads, and imported Chinese porcelains, according to previous burials analysis [@Cheng2008; @Hsieh2009; @Hsieh2012; @Wang2011] and the description in historical records [@Borao2009; @LiandWu2006]. 

# Methods

## data and hypoethesis

We analyzed archaeological burials from a Iron Age site, Kiwulan, in northeastern Taiwan to generate networks. We used burial data collected from the published excavation report, and original fieldwork notes with detailed descriptions about context and stratigraphy. We do not include the burials in Chinese phase in our network analysis because of the small sample size. <!-- but we will briefly discuss these in the discussion section --> We assigned the burials into three classes, high, medium, and low, as an index of wealth, based on the quantity of burial goods. In addition to wealth, we also consider another two social variables, age and gender of the interred individual, serving as indicators for distinguishing ascribed or achieved status in a society [citation]. 

The purpose of our analysis is to understand the underlying mechanisms that shape the relationships between people at Kiwulan, and the effect of foreign contact on these relationships. We hypothesize that after the start of the European presence in the 17th century, a group of ambitious individuals competed with each other for access to trade with the Europeans due to the high value of trade goods in their society. This led to the accumulation of high quality trade goods among a small numbers of individuals. Social inequality gradually increased in Kiwulan, and we predict this can be observed from the burials. We hypothesize a change from a more equal distribution of grave goods to a more differentiated distribution of goods. Thus, we predict that the burial network will present less reciprocality, less transitivity, but higher popularity structure effects <!-- the reader needs to be introduced to these terms before you can use them like this... instead, need to foreground or foreshadow these concepts... "We used network analysis statistics to quantify the relationships and formally test our hypothesis. "--> in burial network after the European presence, compared to the network before European presence.

## Model specification and estimation
<!--Network construction-->

We use Bayesian reference on Exponential Random Graph Models (ERGMs) to conduct statistical network analysis to test what variables may have contributed to the economic inequality observed between burials over time under foreign contact conditions.<!-- seems like a long sentence --> ERGMs assume that each network tie <!-- does the reader know what this is?--> is a random variable which is dependent on each other somehow through the shared attributes or a reciprocal relationship [@Robins2007]. The dependence of ties can be hypothesized by parameters corresponding to configurations in the network, such as a single tie, or a transitive triad <!-- does the reader know what is 'transitive? --> . A model is built up by a distribution of random graphs according to these configurations that are also called network statistics. According to the formation of ties, network statistics can be divided into two types, endogenous statistics and exogenous statistics [@Amati2019]. In endogenous models <!--statistic or model? what exactly? these seem like two different things that are getting mixed up. Choose one way to describe and stick to it to avoid confusing the reader -->, the dependence of ties is decided by the presence of other ties, while in an exogenous model, the dependence of ties is determined by node attributes <!-- node? -->. We use both exogenous and endogenous statistics to understand the characteristics of the burial network at Kiwulan and the correlate of burials. To describe the relationship linked by shared burial goods, the network is weighted to capture the multiple effects <!-- of what? the reader doesn't know about any effects yet --> [@Snijders2006]. The network variables we examine include connectivity, clusters, centralization, and homophily in undirected relations <!-- something wrong here, 'relations' seems wrong here --> to reflect the social relations <!-- avoid repeating the same work in a sentence --> between individuals guided by social structures. Table \@ref(tab:ergm-terms-table) lists the network statistics we used in the model construction for burials with archaeological interpretations <!-- put this earlier in the paragraph --> . Every term in an ERGM has an associated algorithm for computing its value for network [@Morris2008]. 

```{r ergm-terms-table}
ergm_terms <- readxl::read_excel(here("analysis", "data", "raw_data", "ergm_term.xlsx")) 
kableExtra::kable(ergm_terms,
             caption = "The parameters of exponential random graph models for a undirected network to corresponding with archaeological evidence.")
```

We conducted a network analysis using the R programming language with the ergm package for simulation and model specification [@Hunter2008; @Morris2008]. We used the bergm package for Bayesian modeling [@Caimo2014]. <!-- why did we use two packages? why not just one? this needs to be expanded a bit to make it clear to the reader --> We set the number of chains to six. For each chain, the number of burn-in iterations is 200 and the number of iterations after the burn-in is 2000. We set the number of iterations used to simulate a network y‚Ä≤ at each iteration to 10,000. The models are assessed by goodness-of-fit (GOF) diagnostics in the Bayesian framework, where the observed network is compared with the set of networks simulated from the estimated posterior distribution of the parameters of the model [@Caimo2011; @Caimo2017]. This provides a statistical way to check how well the estimated posterior parameter distribution can reproduce networks similar to the general structural features of the observed network. 

<!--Model fitting and comparison to alternative approaches-->

<!-- Goodness-of-fit assessment-->

<!-- "We test our hypothesis by measuring reciprocality,  transitivity, and  popularity structure effects and expect that if our hypothesis is a good match with the data then we should see less reciprocally, less transitivity, but higher popularity structure effects" This is where you can connect the anthropological question, the archaeological hypothesis and the statistical method for testing the hypothesis  -->

# Results

```{r network-ggraph}
# network analysis using ggraph pkg
library(tidygraph)
library(ggraph)
# pre-Euro
relation_tidy_pre <- tbl_graph(nodes = nodes_pre,
                               edges = edges_for_network_pre,
                               directed = FALSE)

relation_tidy_pre %>%
  activate(edges) %>%
  arrange(desc(common_counts))

# plot
ggraph(relation_tidy_pre, layout = "graphopt") +
  geom_node_point() +
  geom_edge_link(aes(width = common_counts), alpha = 0.8) +
  scale_edge_width(range = c(0.2, 2)) +
  geom_node_text(aes(label = burial_label), repel = TRUE) +
  labs(edge_width = "common item") +
  theme_graph()

# post-Euro
relation_tidy_post <- tbl_graph(nodes = nodes_post,
                               edges = edges_for_network_post,
                               directed = FALSE)

relation_tidy_post %>%
  activate(edges) %>%
  arrange(desc(common_counts))

# plot
ggraph(relation_tidy_post, layout = "graphopt") +
  geom_node_point() +
  geom_edge_link(aes(width = common_counts), alpha = 0.8) +
  scale_edge_width(range = c(0.2, 2)) +
  geom_node_text(aes(label = burial_label), repel = TRUE) +
  labs(edge_width = "common item") +
  theme_graph()
```

```{r network-object}
library(network)

burial_network_pre <-
  network(edges_for_network_pre, # the network object
          vertex.attr = nodes_pre, # node list
          directed = FALSE, # specify whether the network is directed
          ignore.eval = FALSE, # FALSE = weighted
          loops = FALSE, # do we allow self ties (should not allow them)
          matrix.type = "edgelist") # the type of input

burial_network_post <-
  network(edges_for_network_post,
          vertex.attr = nodes_post,
          directed = FALSE,
          ignore.eval = FALSE, 
          loops = FALSE, 
          matrix.type = "edgelist") 
```

The pre-European network shows three subgroups that possessing the same types of burial goods: medium amount of carnelian bead on the right, medium amount of gold-foil beads on the left, and porcelains in the middle. Although burials with different amount of burial goods can be identified, there is no clear clusters demonstrating the sharing of prestige goods is limited to burials with rich goods. 

```{r add-node-attribute-color}
# prepare notwork objects for Bayesian ERGMs 
library(statnet)
library(Bergm)

# Add attributes to the network object burial_network_pre
set.vertex.attribute(burial_network_pre, "quantity", burial_pre$quantity)
set.vertex.attribute(burial_network_pre, "age", burial_pre$Age_scale)
set.vertex.attribute(burial_network_pre, "gender", burial_pre$gender)

# plot
set.seed(30)
quantity <- get.vertex.attribute(burial_network_pre, "quantity")
age <- get.vertex.attribute(burial_network_pre, "age")

plot(burial_network_pre,
     displaylabels = TRUE,
     vertex.col = "quantity",
     vertex.cex = degree(burial_network_pre, cmode = 'indegree')/5, #size nodes
     pad = 1) 

legend("topleft",
       col = c(2, 3, 1, 4), # need to adjust each time
       pch    = 20,
       legend = unique(quantity), # age
       title  = 'Burial good counts')

#? can't get the items in legend in order, tried as.factor and set their level but does not work
#? can't match color with categories, using an odd method at the moment

# Add attributes to the network object burial_network_post
set.vertex.attribute(burial_network_post, "quantity", burial_post$quantity)
set.vertex.attribute(burial_network_post, "age", burial_post$Age_scale)
set.vertex.attribute(burial_network_post, "gender", burial_post$gender)

# plot
set.seed(30)
quantity <- get.vertex.attribute(burial_network_post, "quantity")
age <- get.vertex.attribute(burial_network_post, "age")
ID <- get.vertex.attribute(burial_network_post, "burial_label") # not sure how to get id on the network plot

plot(burial_network_post,
     displaylabels = TRUE,
     vertex.col = "quantity",
     vertex.cex = degree(burial_network_post, cmode = 'indegree') / 13, #size nodes to their in-degree
     #vertex.sides = ifelse(burial_network_pre %v% "", 4, 50),
     pad = 1)

legend("topleft",
       col = c(4, 3, 2, 1), # need to adjust each time
       pch    = 20,
       legend = unique(quantity),
       title  = 'Burial good counts')
```

## ERGM parameter estimation
<!--interpretation of network plots across phases--> 

```{r network-ERGMs}
# model 1
model.ergm <- burial_network_pre ~
  edges + # ties, a measure of density, equal to kstar(1) for undirected networks
  density +
  triangle # triad relation, a measure of clustering or cohesion, also called transitive triple in undirected network, can be replaced by "gwdegree"
summary(model.ergm)

# model 2, check here Morris et al. (2008) 
# check out the terms: http://mailman13.u.washington.edu/pipermail/statnet_help/2010/000575.html
model.2 <- burial_network_pre ~ edges + # density
  gwesp(0.2, fixed = TRUE) +  # transitivity(cohesion; triangle)
  # number means weight parameter alpha, which controls the rate of declining marginal returns
  # fixed = TRUE means the scale parameter lambda is fit as a curved exponential-family model
  # not much difference in a range of 0-1.5, the lower the value of the scaling parameter, the less likely the model is to be degenerate
  # ergm can estimate the parameter from the data by using fixed=FALSE

  gwdegree(0.8, fixed = TRUE)  # popularity(degree; star), the frequency distribution for nodal degrees
  # tendency of being in contact with multiple partners, measures of centralisation
  # distribution of node-based edge counts, each node counts only once
  # number means weight parameter decay
  # The closer decay is to zero, the more gwdegree considers low degree nodes relative to high degree nodes
summary(model.2)

# model 3 with node attributes
model.3 <- burial_network_pre ~ edges +  # the overall density of the network
  nodematch('quantity') + # quantity-based homophily
  nodematch('age') +
  nodematch('gender') +
  gwesp(0.75, fixed = TRUE) +    # transitivity
  gwnsp(0.75, fixed = TRUE) +
  gwdegree(0.2, fixed = TRUE) # popularity
summary(model.3)
```

<!--interpretation of Bayesian modeling--> 

Normal distribution ùúÉ ‚àº Nd (ùúáprior , Œ£prior ) is viewed as a suitable prior model for the model parameters of interests in network analysis if there is no previous observation for a network[@Caimo2017]. Since our original data presents a pattern of dense ties, we specified the prior based on our observation that assumes a high density and high transitivity network. 

```{r Bayesian-ERGMs}
# Specify a prior distribution: normal distribution (low density and high transitivity)
# need to observe the graph and select suitable prior 
prior.mean <- c(2, 0, 0, 0, 5, 0, 0) 
# follow Alberto Caimo et al. (2015) hospital example
prior.sigma <- diag(3, 7) # covariance matrix structure
# where the dimension d corresponds to the number of parameters, ùúá is mean vector and Œ£prior is a d √ó d covariance matrix.

# Estimated posterior means, medians and 95% credible intervals for Models.3
# bergmM: Bayesian exponential random graphs models under missing data using the approximate exchange algorithm. Use this because of missing data for age variable
parpost <- bergmM(model.3,
                  prior.mean  = prior.mean,
                  prior.sigma = prior.sigma,
                  burn.in     = 200, # burn-in iterations for every chain of the population, drops the first 200
                  main.iters  = 2000, # iterations for every chain of the population
                  aux.iters   = 10000, # MCMC steps used for network simulation
                  nchains     = 8, # number of chains of the population MCMC
                  gamma       = 0.2) # scalar; parallel adaptive direction sampling move factor, acceptance rate

# summary of parameter estimation
summary(parpost)

# plot the parameter posterior distribution
plot(parpost)
```

## Structure Effects

The network statistics presents each Œ∏ that corresponds to the parameter specified in ERGM previously. In general, positive mean indicates positive correlation, while negative mean indicates negative correlation. 

Œ∏1 = number of ties
Œ∏2 = individuals with the same abundance of burial goods
Œ∏3 = gwesp, a positive sign suggests a tendency of burials in our sample to group together in closed transitive structures. In mortuary context, clustering implies a tendency of burials with the same status indicated by prestige goods to be organised in closed structures. Burials with multiple prestige goods in common are more likely to be directed connected.
Œ∏4 = gwdegree, negative estimates reflect an increased likelihood on ties to higher-degree nodes, or the strong edges are not necessarily centralised or dispersed in the degree distribution.

The plots from left to right show estimated marginal posterior densities, trace plots, and autocorrelation plots.

```{r Bayesian-gof}
# Model assessment, Bayesian goodness of fit diagnostics:
bgof(parpost,
     aux.iters = 10000,
     n.deg     = 15,
     n.dist    = 15,
     n.esp     = 15)

# An estimated ERGM is fitting perfectly a certain observed network if the red line falls inside this interval
# a result that is very difficult to obtain in practice (Caimo 2017)
```

Figure shows the Bayesian goodness of fit diagnostics plots where the red lines represent the distributions of the observed data and the box plots represent the GOF distributions of 10000 network graphs simulated from ERGMs based on the estimated posterior distribution. The grey lines mark the 95% intervals. X-axis means the proportion of nodes

# Discussion

# Conclusion

# Acknowledgments

<!-- The following line inserts a page break when the output is MS Word. For page breaks in PDF, use \newpage on its own line.  -->
##### pagebreak

# References 
<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->
<div id="refs"></div>

##### pagebreak

### Colophon

This report was generated on `r Sys.time()` using the following computational environment and dependencies: 

```{r colophon, cache = FALSE}
# which R packages and versions?
if ("devtools" %in% installed.packages()) devtools::session_info()
```

The current Git commit details are:

```{r}
# what commit is this file at? 
if ("git2r" %in% installed.packages() & git2r::in_repository(path = ".")) git2r::repository(here::here())  
```
